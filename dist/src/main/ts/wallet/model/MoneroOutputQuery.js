"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _MoneroError = _interopRequireDefault(require("../../common/MoneroError"));

var _MoneroOutputWallet = _interopRequireDefault(require("./MoneroOutputWallet"));


var _MoneroTxQuery = _interopRequireDefault(require("./MoneroTxQuery"));

/**
 * Configuration to query wallet outputs.
 */
class MoneroOutputQuery extends _MoneroOutputWallet.default {






  /**
   * <p>Construct the output query.</p>
   * 
   * <p>Example:</p>
   * 
   * <code>
   * &sol;&sol; get available outputs in account 0 with a minimum amount<br>
   * let outputs = await wallet.getOutputs({<br>
   * &nbsp;&nbsp; isSpent: false,<br>
   * &nbsp;&nbsp; isLocked: false,<br>
   * &nbsp;&nbsp; accountIndex: 0,<br>
   * &nbsp;&nbsp; minAmount: 750000n<br>
   * });
   * </code>
   * 
   * <p>All configuration is optional.  All outputs are returned except those that don't meet criteria defined in this query.</p>
   * 
   * @param {MoneroOutputQuery} [config] - output query configuration (optional)
   * @param {number} config.accountIndex - get outputs in this account index
   * @param {number} config.subaddressIndex - get outputs in this subaddress index
   * @param {number[]} config.subaddressIndices - get outputs in these subaddress indices
   * @param {bigint} config.amount - get outputs with this amount
   * @param {bigint} config.minAmount - get outputs with amount greater than or equal to this amount
   * @param {bigint} config.maxAmount - get outputs with amount less than or equal to this amount
   * @param {boolean} config.isSpent - get spent xor unspent outputs
   * @param {boolean} config.isFrozen - get frozen xor thawed outputs
   * @param {MoneroKeyImage} config.keyImage - get outputs with a key image matching fields defined in this key image
   * @param {string} config.keyImage.hex - get outputs with this key image hex
   * @param {string} config.keyImage.signature - get outputs with this key image signature
   * @param {MoneroTxQuery} config.txQuery - get outputs whose tx match this tx query
   */
  constructor(query) {
    super(query);
    if (this.minAmount !== undefined && typeof this.minAmount !== "bigint") this.minAmount = BigInt(this.minAmount);
    if (this.maxAmount !== undefined && typeof this.maxAmount !== "bigint") this.maxAmount = BigInt(this.maxAmount);
    if (this.txQuery && !(this.txQuery instanceof _MoneroTxQuery.default)) this.txQuery = new _MoneroTxQuery.default(this.txQuery);
    if (this.txQuery) this.txQuery.setOutputQuery(this);
    if (this.isLocked !== undefined) throw new _MoneroError.default("isLocked must be part of tx query, not output query");
  }

  copy() {
    return new MoneroOutputQuery(this);
  }

  toJson() {
    let json = Object.assign({}, this, super.toJson());
    if (this.getMinAmount() !== undefined) json.minAmount = this.getMinAmount().toString();
    if (this.getMaxAmount() !== undefined) json.maxAmount = this.getMaxAmount().toString();
    delete json.txQuery;
    return json;
  }

  getMinAmount() {
    return this.minAmount;
  }

  setMinAmount(minAmount) {
    this.minAmount = minAmount;
    return this;
  }

  getMaxAmount() {
    return this.maxAmount;
  }

  setMaxAmount(maxAmount) {
    this.maxAmount = maxAmount;
    return this;
  }

  getTxQuery() {
    return this.txQuery;
  }

  setTxQuery(txQuery) {
    this.txQuery = txQuery === undefined ? undefined : txQuery instanceof _MoneroTxQuery.default ? txQuery : new _MoneroTxQuery.default(txQuery);
    if (txQuery) this.txQuery.outputQuery = this;
    return this;
  }

  getSubaddressIndices() {
    return this.subaddressIndices;
  }

  setSubaddressIndices(subaddressIndices) {
    this.subaddressIndices = subaddressIndices;
    return this;
  }

  meetsCriteria(output, queryParent = true) {
    if (!(output instanceof _MoneroOutputWallet.default)) throw new Error("Output not given to MoneroOutputQuery.meetsCriteria(output)");

    // filter on output
    if (this.getAccountIndex() !== undefined && this.getAccountIndex() !== output.getAccountIndex()) return false;
    if (this.getSubaddressIndex() !== undefined && this.getSubaddressIndex() !== output.getSubaddressIndex()) return false;
    if (this.getAmount() !== undefined && this.getAmount() !== output.getAmount()) return false;
    if (this.getIsSpent() !== undefined && this.getIsSpent() !== output.getIsSpent()) return false;
    if (this.getIsFrozen() !== undefined && this.getIsFrozen() !== output.getIsFrozen()) return false;

    // filter on output's key image
    if (this.getKeyImage() !== undefined) {
      if (output.getKeyImage() === undefined) return false;
      if (this.getKeyImage().getHex() !== undefined && this.getKeyImage().getHex() !== output.getKeyImage().getHex()) return false;
      if (this.getKeyImage().getSignature() !== undefined && this.getKeyImage().getSignature() !== output.getKeyImage().getSignature()) return false;
    }

    // filter on extensions
    if (this.getSubaddressIndices() !== undefined && !this.getSubaddressIndices().includes(output.getSubaddressIndex())) return false;

    // filter with tx query
    if (this.getTxQuery() && !this.getTxQuery().meetsCriteria(output.getTx(), false)) return false;

    // filter on remaining fields
    if (this.getMinAmount() !== undefined && (output.getAmount() === undefined || output.getAmount() < this.getMinAmount())) return false;
    if (this.getMaxAmount() !== undefined && (output.getAmount() === undefined || output.getAmount() > this.getMaxAmount())) return false;

    // output meets query
    return true;
  }

  // -------------------- OVERRIDE COVARIANT RETURN TYPES ---------------------

  setTx(tx) {
    super.setTx(tx);
    return this;
  }

  setAccountIndex(accountIndex) {
    super.setAccountIndex(accountIndex);
    return this;
  }

  setSubaddressIndex(subaddressIndex) {
    super.setSubaddressIndex(subaddressIndex);
    return this;
  }

  setIsSpent(isSpent) {
    super.setIsSpent(isSpent);
    return this;
  }

  setIsFrozen(isFrozen) {
    super.setIsFrozen(isFrozen);
    return this;
  }

  setKeyImage(keyImage) {
    super.setKeyImage(keyImage);
    return this;
  }

  setAmount(amount) {
    super.setAmount(amount);
    return this;
  }

  setIndex(index) {
    super.setIndex(index);
    return this;
  }

  setRingOutputIndices(ringOutputIndices) {
    super.setRingOutputIndices(ringOutputIndices);
    return this;
  }

  setStealthPublicKey(stealthPublicKey) {
    super.setStealthPublicKey(stealthPublicKey);
    return this;
  }
}exports.default = MoneroOutputQuery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfTW9uZXJvRXJyb3IiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9Nb25lcm9PdXRwdXRXYWxsZXQiLCJfTW9uZXJvVHhRdWVyeSIsIk1vbmVyb091dHB1dFF1ZXJ5IiwiTW9uZXJvT3V0cHV0V2FsbGV0IiwiY29uc3RydWN0b3IiLCJxdWVyeSIsIm1pbkFtb3VudCIsInVuZGVmaW5lZCIsIkJpZ0ludCIsIm1heEFtb3VudCIsInR4UXVlcnkiLCJNb25lcm9UeFF1ZXJ5Iiwic2V0T3V0cHV0UXVlcnkiLCJpc0xvY2tlZCIsIk1vbmVyb0Vycm9yIiwiY29weSIsInRvSnNvbiIsImpzb24iLCJPYmplY3QiLCJhc3NpZ24iLCJnZXRNaW5BbW91bnQiLCJ0b1N0cmluZyIsImdldE1heEFtb3VudCIsInNldE1pbkFtb3VudCIsInNldE1heEFtb3VudCIsImdldFR4UXVlcnkiLCJzZXRUeFF1ZXJ5Iiwib3V0cHV0UXVlcnkiLCJnZXRTdWJhZGRyZXNzSW5kaWNlcyIsInN1YmFkZHJlc3NJbmRpY2VzIiwic2V0U3ViYWRkcmVzc0luZGljZXMiLCJtZWV0c0NyaXRlcmlhIiwib3V0cHV0IiwicXVlcnlQYXJlbnQiLCJFcnJvciIsImdldEFjY291bnRJbmRleCIsImdldFN1YmFkZHJlc3NJbmRleCIsImdldEFtb3VudCIsImdldElzU3BlbnQiLCJnZXRJc0Zyb3plbiIsImdldEtleUltYWdlIiwiZ2V0SGV4IiwiZ2V0U2lnbmF0dXJlIiwiaW5jbHVkZXMiLCJnZXRUeCIsInNldFR4IiwidHgiLCJzZXRBY2NvdW50SW5kZXgiLCJhY2NvdW50SW5kZXgiLCJzZXRTdWJhZGRyZXNzSW5kZXgiLCJzdWJhZGRyZXNzSW5kZXgiLCJzZXRJc1NwZW50IiwiaXNTcGVudCIsInNldElzRnJvemVuIiwiaXNGcm96ZW4iLCJzZXRLZXlJbWFnZSIsImtleUltYWdlIiwic2V0QW1vdW50IiwiYW1vdW50Iiwic2V0SW5kZXgiLCJpbmRleCIsInNldFJpbmdPdXRwdXRJbmRpY2VzIiwicmluZ091dHB1dEluZGljZXMiLCJzZXRTdGVhbHRoUHVibGljS2V5Iiwic3RlYWx0aFB1YmxpY0tleSIsImV4cG9ydHMiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL21haW4vdHMvd2FsbGV0L21vZGVsL01vbmVyb091dHB1dFF1ZXJ5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNb25lcm9FcnJvciBmcm9tIFwiLi4vLi4vY29tbW9uL01vbmVyb0Vycm9yXCI7XG5pbXBvcnQgTW9uZXJvS2V5SW1hZ2UgZnJvbSBcIi4uLy4uL2RhZW1vbi9tb2RlbC9Nb25lcm9LZXlJbWFnZVwiO1xuaW1wb3J0IE1vbmVyb091dHB1dFdhbGxldCBmcm9tIFwiLi9Nb25lcm9PdXRwdXRXYWxsZXRcIjtcbmltcG9ydCBNb25lcm9UeCBmcm9tIFwiLi4vLi4vZGFlbW9uL21vZGVsL01vbmVyb1R4XCI7XG5pbXBvcnQgTW9uZXJvVHhXYWxsZXQgZnJvbSBcIi4vTW9uZXJvVHhXYWxsZXRcIjtcbmltcG9ydCBNb25lcm9UeFF1ZXJ5IGZyb20gXCIuL01vbmVyb1R4UXVlcnlcIjtcblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIHRvIHF1ZXJ5IHdhbGxldCBvdXRwdXRzLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb25lcm9PdXRwdXRRdWVyeSBleHRlbmRzIE1vbmVyb091dHB1dFdhbGxldCB7XG5cbiAgbWluQW1vdW50OiBiaWdpbnQ7XG4gIG1heEFtb3VudDogYmlnaW50O1xuICB0eFF1ZXJ5OiBQYXJ0aWFsPE1vbmVyb1R4UXVlcnk+O1xuICBzdWJhZGRyZXNzSW5kaWNlczogbnVtYmVyW107XG5cbiAgLyoqXG4gICAqIDxwPkNvbnN0cnVjdCB0aGUgb3V0cHV0IHF1ZXJ5LjwvcD5cbiAgICogXG4gICAqIDxwPkV4YW1wbGU6PC9wPlxuICAgKiBcbiAgICogPGNvZGU+XG4gICAqICZzb2w7JnNvbDsgZ2V0IGF2YWlsYWJsZSBvdXRwdXRzIGluIGFjY291bnQgMCB3aXRoIGEgbWluaW11bSBhbW91bnQ8YnI+XG4gICAqIGxldCBvdXRwdXRzID0gYXdhaXQgd2FsbGV0LmdldE91dHB1dHMoezxicj5cbiAgICogJm5ic3A7Jm5ic3A7IGlzU3BlbnQ6IGZhbHNlLDxicj5cbiAgICogJm5ic3A7Jm5ic3A7IGlzTG9ja2VkOiBmYWxzZSw8YnI+XG4gICAqICZuYnNwOyZuYnNwOyBhY2NvdW50SW5kZXg6IDAsPGJyPlxuICAgKiAmbmJzcDsmbmJzcDsgbWluQW1vdW50OiA3NTAwMDBuPGJyPlxuICAgKiB9KTtcbiAgICogPC9jb2RlPlxuICAgKiBcbiAgICogPHA+QWxsIGNvbmZpZ3VyYXRpb24gaXMgb3B0aW9uYWwuICBBbGwgb3V0cHV0cyBhcmUgcmV0dXJuZWQgZXhjZXB0IHRob3NlIHRoYXQgZG9uJ3QgbWVldCBjcml0ZXJpYSBkZWZpbmVkIGluIHRoaXMgcXVlcnkuPC9wPlxuICAgKiBcbiAgICogQHBhcmFtIHtNb25lcm9PdXRwdXRRdWVyeX0gW2NvbmZpZ10gLSBvdXRwdXQgcXVlcnkgY29uZmlndXJhdGlvbiAob3B0aW9uYWwpXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBjb25maWcuYWNjb3VudEluZGV4IC0gZ2V0IG91dHB1dHMgaW4gdGhpcyBhY2NvdW50IGluZGV4XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBjb25maWcuc3ViYWRkcmVzc0luZGV4IC0gZ2V0IG91dHB1dHMgaW4gdGhpcyBzdWJhZGRyZXNzIGluZGV4XG4gICAqIEBwYXJhbSB7bnVtYmVyW119IGNvbmZpZy5zdWJhZGRyZXNzSW5kaWNlcyAtIGdldCBvdXRwdXRzIGluIHRoZXNlIHN1YmFkZHJlc3MgaW5kaWNlc1xuICAgKiBAcGFyYW0ge2JpZ2ludH0gY29uZmlnLmFtb3VudCAtIGdldCBvdXRwdXRzIHdpdGggdGhpcyBhbW91bnRcbiAgICogQHBhcmFtIHtiaWdpbnR9IGNvbmZpZy5taW5BbW91bnQgLSBnZXQgb3V0cHV0cyB3aXRoIGFtb3VudCBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhpcyBhbW91bnRcbiAgICogQHBhcmFtIHtiaWdpbnR9IGNvbmZpZy5tYXhBbW91bnQgLSBnZXQgb3V0cHV0cyB3aXRoIGFtb3VudCBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gdGhpcyBhbW91bnRcbiAgICogQHBhcmFtIHtib29sZWFufSBjb25maWcuaXNTcGVudCAtIGdldCBzcGVudCB4b3IgdW5zcGVudCBvdXRwdXRzXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gY29uZmlnLmlzRnJvemVuIC0gZ2V0IGZyb3plbiB4b3IgdGhhd2VkIG91dHB1dHNcbiAgICogQHBhcmFtIHtNb25lcm9LZXlJbWFnZX0gY29uZmlnLmtleUltYWdlIC0gZ2V0IG91dHB1dHMgd2l0aCBhIGtleSBpbWFnZSBtYXRjaGluZyBmaWVsZHMgZGVmaW5lZCBpbiB0aGlzIGtleSBpbWFnZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gY29uZmlnLmtleUltYWdlLmhleCAtIGdldCBvdXRwdXRzIHdpdGggdGhpcyBrZXkgaW1hZ2UgaGV4XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb25maWcua2V5SW1hZ2Uuc2lnbmF0dXJlIC0gZ2V0IG91dHB1dHMgd2l0aCB0aGlzIGtleSBpbWFnZSBzaWduYXR1cmVcbiAgICogQHBhcmFtIHtNb25lcm9UeFF1ZXJ5fSBjb25maWcudHhRdWVyeSAtIGdldCBvdXRwdXRzIHdob3NlIHR4IG1hdGNoIHRoaXMgdHggcXVlcnlcbiAgICovXG4gIGNvbnN0cnVjdG9yKHF1ZXJ5PzogUGFydGlhbDxNb25lcm9PdXRwdXRRdWVyeT4pIHtcbiAgICBzdXBlcihxdWVyeSk7XG4gICAgaWYgKHRoaXMubWluQW1vdW50ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHRoaXMubWluQW1vdW50ICE9PSBcImJpZ2ludFwiKSB0aGlzLm1pbkFtb3VudCA9IEJpZ0ludCh0aGlzLm1pbkFtb3VudCk7XG4gICAgaWYgKHRoaXMubWF4QW1vdW50ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHRoaXMubWF4QW1vdW50ICE9PSBcImJpZ2ludFwiKSB0aGlzLm1heEFtb3VudCA9IEJpZ0ludCh0aGlzLm1heEFtb3VudCk7XG4gICAgaWYgKHRoaXMudHhRdWVyeSAmJiAhKHRoaXMudHhRdWVyeSBpbnN0YW5jZW9mIE1vbmVyb1R4UXVlcnkpKSB0aGlzLnR4UXVlcnkgPSBuZXcgTW9uZXJvVHhRdWVyeSh0aGlzLnR4UXVlcnkpO1xuICAgIGlmICh0aGlzLnR4UXVlcnkpIHRoaXMudHhRdWVyeS5zZXRPdXRwdXRRdWVyeSh0aGlzKTtcbiAgICBpZiAodGhpcy5pc0xvY2tlZCAhPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgTW9uZXJvRXJyb3IoXCJpc0xvY2tlZCBtdXN0IGJlIHBhcnQgb2YgdHggcXVlcnksIG5vdCBvdXRwdXQgcXVlcnlcIik7XG4gIH1cbiAgXG4gIGNvcHkoKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHJldHVybiBuZXcgTW9uZXJvT3V0cHV0UXVlcnkodGhpcyk7XG4gIH1cbiAgXG4gIHRvSnNvbigpOiBhbnkge1xuICAgIGxldCBqc29uID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcywgc3VwZXIudG9Kc29uKCkpO1xuICAgIGlmICh0aGlzLmdldE1pbkFtb3VudCgpICE9PSB1bmRlZmluZWQpIGpzb24ubWluQW1vdW50ID0gdGhpcy5nZXRNaW5BbW91bnQoKS50b1N0cmluZygpO1xuICAgIGlmICh0aGlzLmdldE1heEFtb3VudCgpICE9PSB1bmRlZmluZWQpIGpzb24ubWF4QW1vdW50ID0gdGhpcy5nZXRNYXhBbW91bnQoKS50b1N0cmluZygpO1xuICAgIGRlbGV0ZSBqc29uLnR4UXVlcnk7XG4gICAgcmV0dXJuIGpzb247XG4gIH1cbiAgXG4gIGdldE1pbkFtb3VudCgpOiBiaWdpbnQge1xuICAgIHJldHVybiB0aGlzLm1pbkFtb3VudDtcbiAgfVxuXG4gIHNldE1pbkFtb3VudChtaW5BbW91bnQ6IGJpZ2ludCk6IE1vbmVyb091dHB1dFF1ZXJ5IHtcbiAgICB0aGlzLm1pbkFtb3VudCA9IG1pbkFtb3VudDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGdldE1heEFtb3VudCgpOiBiaWdpbnQge1xuICAgIHJldHVybiB0aGlzLm1heEFtb3VudDtcbiAgfVxuXG4gIHNldE1heEFtb3VudChtYXhBbW91bnQ6IGJpZ2ludCk6IE1vbmVyb091dHB1dFF1ZXJ5IHtcbiAgICB0aGlzLm1heEFtb3VudCA9IG1heEFtb3VudDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBcbiAgZ2V0VHhRdWVyeSgpOiBNb25lcm9UeFF1ZXJ5IHtcbiAgICByZXR1cm4gdGhpcy50eFF1ZXJ5IGFzIE1vbmVyb1R4UXVlcnk7XG4gIH1cbiAgXG4gIHNldFR4UXVlcnkodHhRdWVyeTogTW9uZXJvVHhRdWVyeSk6IE1vbmVyb091dHB1dFF1ZXJ5IHtcbiAgICB0aGlzLnR4UXVlcnkgPSB0eFF1ZXJ5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB0eFF1ZXJ5IGluc3RhbmNlb2YgTW9uZXJvVHhRdWVyeSA/IHR4UXVlcnkgOiBuZXcgTW9uZXJvVHhRdWVyeSh0eFF1ZXJ5KTtcbiAgICBpZiAodHhRdWVyeSkgdGhpcy50eFF1ZXJ5Lm91dHB1dFF1ZXJ5ID0gdGhpcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBcbiAgZ2V0U3ViYWRkcmVzc0luZGljZXMoKTogbnVtYmVyW10ge1xuICAgIHJldHVybiB0aGlzLnN1YmFkZHJlc3NJbmRpY2VzO1xuICB9XG4gIFxuICBzZXRTdWJhZGRyZXNzSW5kaWNlcyhzdWJhZGRyZXNzSW5kaWNlczogbnVtYmVyW10pOiBNb25lcm9PdXRwdXRRdWVyeSB7XG4gICAgdGhpcy5zdWJhZGRyZXNzSW5kaWNlcyA9IHN1YmFkZHJlc3NJbmRpY2VzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG4gIFxuICBtZWV0c0NyaXRlcmlhKG91dHB1dDogTW9uZXJvT3V0cHV0V2FsbGV0LCBxdWVyeVBhcmVudCA9IHRydWUpOiBib29sZWFuIHtcbiAgICBpZiAoIShvdXRwdXQgaW5zdGFuY2VvZiBNb25lcm9PdXRwdXRXYWxsZXQpKSB0aHJvdyBuZXcgRXJyb3IoXCJPdXRwdXQgbm90IGdpdmVuIHRvIE1vbmVyb091dHB1dFF1ZXJ5Lm1lZXRzQ3JpdGVyaWEob3V0cHV0KVwiKTtcbiAgICBcbiAgICAvLyBmaWx0ZXIgb24gb3V0cHV0XG4gICAgaWYgKHRoaXMuZ2V0QWNjb3VudEluZGV4KCkgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmdldEFjY291bnRJbmRleCgpICE9PSBvdXRwdXQuZ2V0QWNjb3VudEluZGV4KCkpIHJldHVybiBmYWxzZTtcbiAgICBpZiAodGhpcy5nZXRTdWJhZGRyZXNzSW5kZXgoKSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZ2V0U3ViYWRkcmVzc0luZGV4KCkgIT09IG91dHB1dC5nZXRTdWJhZGRyZXNzSW5kZXgoKSkgcmV0dXJuIGZhbHNlO1xuICAgIGlmICh0aGlzLmdldEFtb3VudCgpICE9PSB1bmRlZmluZWQgJiYgdGhpcy5nZXRBbW91bnQoKSAhPT0gb3V0cHV0LmdldEFtb3VudCgpKSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKHRoaXMuZ2V0SXNTcGVudCgpICE9PSB1bmRlZmluZWQgJiYgdGhpcy5nZXRJc1NwZW50KCkgIT09IG91dHB1dC5nZXRJc1NwZW50KCkpIHJldHVybiBmYWxzZTtcbiAgICBpZiAodGhpcy5nZXRJc0Zyb3plbigpICE9PSB1bmRlZmluZWQgJiYgdGhpcy5nZXRJc0Zyb3plbigpICE9PSBvdXRwdXQuZ2V0SXNGcm96ZW4oKSkgcmV0dXJuIGZhbHNlO1xuICAgIFxuICAgIC8vIGZpbHRlciBvbiBvdXRwdXQncyBrZXkgaW1hZ2VcbiAgICBpZiAodGhpcy5nZXRLZXlJbWFnZSgpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChvdXRwdXQuZ2V0S2V5SW1hZ2UoKSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7XG4gICAgICBpZiAodGhpcy5nZXRLZXlJbWFnZSgpLmdldEhleCgpICE9PSB1bmRlZmluZWQgJiYgdGhpcy5nZXRLZXlJbWFnZSgpLmdldEhleCgpICE9PSBvdXRwdXQuZ2V0S2V5SW1hZ2UoKS5nZXRIZXgoKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgaWYgKHRoaXMuZ2V0S2V5SW1hZ2UoKS5nZXRTaWduYXR1cmUoKSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZ2V0S2V5SW1hZ2UoKS5nZXRTaWduYXR1cmUoKSAhPT0gb3V0cHV0LmdldEtleUltYWdlKCkuZ2V0U2lnbmF0dXJlKCkpIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgXG4gICAgLy8gZmlsdGVyIG9uIGV4dGVuc2lvbnNcbiAgICBpZiAodGhpcy5nZXRTdWJhZGRyZXNzSW5kaWNlcygpICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuZ2V0U3ViYWRkcmVzc0luZGljZXMoKS5pbmNsdWRlcyhvdXRwdXQuZ2V0U3ViYWRkcmVzc0luZGV4KCkpKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgLy8gZmlsdGVyIHdpdGggdHggcXVlcnlcbiAgICBpZiAodGhpcy5nZXRUeFF1ZXJ5KCkgJiYgIXRoaXMuZ2V0VHhRdWVyeSgpLm1lZXRzQ3JpdGVyaWEob3V0cHV0LmdldFR4KCkgYXMgTW9uZXJvVHhXYWxsZXQsIGZhbHNlKSkgcmV0dXJuIGZhbHNlO1xuICAgIFxuICAgIC8vIGZpbHRlciBvbiByZW1haW5pbmcgZmllbGRzXG4gICAgaWYgKHRoaXMuZ2V0TWluQW1vdW50KCkgIT09IHVuZGVmaW5lZCAmJiAob3V0cHV0LmdldEFtb3VudCgpID09PSB1bmRlZmluZWQgfHwgb3V0cHV0LmdldEFtb3VudCgpIDwgdGhpcy5nZXRNaW5BbW91bnQoKSkpIHJldHVybiBmYWxzZTtcbiAgICBpZiAodGhpcy5nZXRNYXhBbW91bnQoKSAhPT0gdW5kZWZpbmVkICYmIChvdXRwdXQuZ2V0QW1vdW50KCkgPT09IHVuZGVmaW5lZCB8fCBvdXRwdXQuZ2V0QW1vdW50KCkgPiB0aGlzLmdldE1heEFtb3VudCgpKSkgcmV0dXJuIGZhbHNlO1xuICAgIFxuICAgIC8vIG91dHB1dCBtZWV0cyBxdWVyeVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0gT1ZFUlJJREUgQ09WQVJJQU5UIFJFVFVSTiBUWVBFUyAtLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICBzZXRUeCh0eDogTW9uZXJvVHgpOiBNb25lcm9PdXRwdXRRdWVyeSB7XG4gICAgc3VwZXIuc2V0VHgodHgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0QWNjb3VudEluZGV4KGFjY291bnRJbmRleDogbnVtYmVyKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldEFjY291bnRJbmRleChhY2NvdW50SW5kZXgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0U3ViYWRkcmVzc0luZGV4KHN1YmFkZHJlc3NJbmRleDogbnVtYmVyKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldFN1YmFkZHJlc3NJbmRleChzdWJhZGRyZXNzSW5kZXgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0SXNTcGVudChpc1NwZW50OiBib29sZWFuKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldElzU3BlbnQoaXNTcGVudCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbiAgXG4gIHNldElzRnJvemVuKGlzRnJvemVuOiBib29sZWFuKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldElzRnJvemVuKGlzRnJvemVuKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBcbiAgc2V0S2V5SW1hZ2Uoa2V5SW1hZ2U6IE1vbmVyb0tleUltYWdlKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldEtleUltYWdlKGtleUltYWdlKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldEFtb3VudChhbW91bnQ6IGJpZ2ludCk6IE1vbmVyb091dHB1dFF1ZXJ5IHtcbiAgICBzdXBlci5zZXRBbW91bnQoYW1vdW50KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldEluZGV4KGluZGV4OiBudW1iZXIpOiBNb25lcm9PdXRwdXRRdWVyeSB7XG4gICAgc3VwZXIuc2V0SW5kZXgoaW5kZXgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0UmluZ091dHB1dEluZGljZXMocmluZ091dHB1dEluZGljZXM6IG51bWJlcltdKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldFJpbmdPdXRwdXRJbmRpY2VzKHJpbmdPdXRwdXRJbmRpY2VzKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldFN0ZWFsdGhQdWJsaWNLZXkoc3RlYWx0aFB1YmxpY0tleTogc3RyaW5nKTogTW9uZXJvT3V0cHV0UXVlcnkge1xuICAgIHN1cGVyLnNldFN0ZWFsdGhQdWJsaWNLZXkoc3RlYWx0aFB1YmxpY0tleSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6InlMQUFBLElBQUFBLFlBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTs7QUFFQSxJQUFBQyxtQkFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBOzs7QUFHQSxJQUFBRSxjQUFBLEdBQUFILHNCQUFBLENBQUFDLE9BQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ2UsTUFBTUcsaUJBQWlCLFNBQVNDLDJCQUFrQixDQUFDOzs7Ozs7O0VBT2hFO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VDLFdBQVdBLENBQUNDLEtBQWtDLEVBQUU7SUFDOUMsS0FBSyxDQUFDQSxLQUFLLENBQUM7SUFDWixJQUFJLElBQUksQ0FBQ0MsU0FBUyxLQUFLQyxTQUFTLElBQUksT0FBTyxJQUFJLENBQUNELFNBQVMsS0FBSyxRQUFRLEVBQUUs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